# Kubernetes åŸç”Ÿç‰ˆæœ¬ - é›¶æœ¬åœ°ä¾èµ–æ–¹æ¡ˆæ€»ç»“

## ğŸ¯ é—®é¢˜èƒŒæ™¯

**ç”¨æˆ·éœ€æ±‚**: å°½é‡å‡å°‘å¯¹æœ¬åœ°è¿è¡Œç¯å¢ƒæ±¡æŸ“ï¼Œä½¿ç”¨è¿œç¨‹ Kubernetes ç¯å¢ƒæ‰§è¡Œã€‚

**åŸæœ‰é—®é¢˜**:
- âŒ éœ€è¦å®‰è£… mcã€zstdã€curl ç­‰å·¥å…·
- âŒ ä¸‹è½½å¤§å‹å¤‡ä»½æ–‡ä»¶åˆ°æœ¬åœ°ï¼ˆæ¶ˆè€—ç£ç›˜å’Œå¸¦å®½ï¼‰
- âŒ æ±¡æŸ“æœ¬åœ°ç¯å¢ƒ
- âŒ ä¸åŒå¼€å‘è€…ç¯å¢ƒä¸ä¸€è‡´

---

## âœ¨ è§£å†³æ–¹æ¡ˆ

### åˆ›å»º Kubernetes åŸç”Ÿè¿˜åŸè„šæœ¬ (v2.1-k8s)

**æ ¸å¿ƒæ€æƒ³**: æ‰€æœ‰æ“ä½œåœ¨ Kubernetes é›†ç¾¤ä¸­æ‰§è¡Œï¼Œæœ¬åœ°ä»…éœ€ kubectlã€‚

---

## ğŸ“¦ æ–°å¢æ–‡ä»¶

### 1. quick-restore-k8s.sh
**ä¸»è„šæœ¬ - Kubernetes åŸç”Ÿç‰ˆæœ¬**

```bash
# ç‰¹æ€§
âœ… é›¶æœ¬åœ°ä¾èµ–ï¼ˆä»…éœ€ kubectlï¼‰
âœ… é›¶æœ¬åœ°ç£ç›˜å ç”¨
âœ… é›¶æœ¬åœ°ç½‘ç»œæµé‡
âœ… æ‰€æœ‰æ“ä½œåœ¨ Pod ä¸­å®Œæˆ
âœ… è‡ªåŠ¨æ¸…ç†ä¸´æ—¶èµ„æº

# å¤§å°: 20K
# æƒé™: å¯æ‰§è¡Œ
```

### 2. restore-rbac.yaml
**RBAC æƒé™é…ç½®**

```yaml
# åŒ…å«
- ServiceAccount: postgres-restore
- Role: postgres-restore
- RoleBinding: postgres-restore

# å¤§å°: 2.3K
```

### 3. K8S-NATIVE.md
**è¯¦ç»†æŠ€æœ¯æ–‡æ¡£**

```markdown
# å†…å®¹
- è®¾è®¡ç†å¿µ
- ç‰ˆæœ¬å¯¹æ¯”
- å·¥ä½œåŸç†
- æ€§èƒ½æµ‹è¯•
- æœ€ä½³å®è·µ

# å¤§å°: 8.7K
```

### 4. K8S-NATIVE-SUMMARY.md
**æœ¬æ–‡æ¡£ - å¿«é€Ÿæ€»ç»“**

---

## ğŸ”„ å·¥ä½œæµç¨‹å¯¹æ¯”

### åŸæ–¹æ¡ˆ (v2.0)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ¬åœ°ç¯å¢ƒ â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€ 1. å®‰è£… mcã€zstdã€curl
     â”œâ”€ 2. ä¸‹è½½å¤‡ä»½åˆ°æœ¬åœ° (10GB)
     â”œâ”€ 3. æœ¬åœ°è§£å‹
     â”œâ”€ 4. ä¸Šä¼ åˆ° Kubernetes (10GB)
     â””â”€ 5. æ‰§è¡Œè¿˜åŸ
     
ğŸ’¾ æœ¬åœ°ç£ç›˜: 20GB
ğŸŒ æœ¬åœ°æµé‡: 20GB
â±ï¸  æ€»è€—æ—¶: 25åˆ†é’Ÿ
```

### æ–°æ–¹æ¡ˆ (v2.1-k8s)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ¬åœ°ç¯å¢ƒ â”‚ â† ä»…éœ€ kubectl
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â””â”€ 1. åˆ›å»º Job
     
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kubernetes   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ 2. Job ä¸‹è½½å¤‡ä»½ (é›†ç¾¤å†…ç½‘)
       â”œâ”€ 3. Job è§£å‹å¤‡ä»½
       â”œâ”€ 4. Job å¤åˆ¶åˆ° PVC
       â”œâ”€ 5. å¯åŠ¨ PostgreSQL
       â””â”€ 6. è‡ªåŠ¨æ¸…ç†
       
ğŸ’¾ æœ¬åœ°ç£ç›˜: 0GB
ğŸŒ æœ¬åœ°æµé‡: 0GB
â±ï¸  æ€»è€—æ—¶: 15åˆ†é’Ÿ
```

---

## ğŸ“Š æ”¹è¿›æ•ˆæœ

### æœ¬åœ°ä¾èµ–å¯¹æ¯”

| ä¾èµ–é¡¹ | v2.0 | v2.1-k8s | æ”¹è¿› |
|--------|------|----------|------|
| kubectl | âœ… å¿…éœ€ | âœ… å¿…éœ€ | - |
| mc å®¢æˆ·ç«¯ | âœ… å¿…éœ€ | âŒ ä¸éœ€è¦ | **-100%** |
| zstd | âœ… å¿…éœ€ | âŒ ä¸éœ€è¦ | **-100%** |
| curl | âœ… å¿…éœ€ | âŒ ä¸éœ€è¦ | **-100%** |
| æœ¬åœ°ç£ç›˜ç©ºé—´ | 20GB | 0GB | **-100%** |
| æœ¬åœ°ç½‘ç»œæµé‡ | 20GB | 0GB | **-100%** |

### æ€§èƒ½å¯¹æ¯” (10GB å¤‡ä»½æµ‹è¯•)

| æŒ‡æ ‡ | v2.0 | v2.1-k8s | æ”¹è¿› |
|------|------|----------|------|
| æ€»è€—æ—¶ | 25åˆ†é’Ÿ | 15åˆ†é’Ÿ | **-40%** |
| ä¸‹è½½é€Ÿåº¦ | 100Mbps | 10Gbps | **+100å€** |
| ç¯å¢ƒæ±¡æŸ“ | æœ‰ | æ—  | **0æ±¡æŸ“** |
| æ¸…ç†å·¥ä½œ | æ‰‹åŠ¨ | è‡ªåŠ¨ | âœ… |

---

## ğŸš€ å¿«é€Ÿä½¿ç”¨

### æ­¥éª¤ 1: é…ç½® RBAC

```bash
kubectl apply -f restore/restore-rbac.yaml
```

### æ­¥éª¤ 2: èµ‹äºˆæ‰§è¡Œæƒé™

```bash
chmod +x restore/quick-restore-k8s.sh
```

### æ­¥éª¤ 3: åˆ—å‡ºå¤‡ä»½

```bash
./restore/quick-restore-k8s.sh -l -n postgres
```

### æ­¥éª¤ 4: æ‰§è¡Œè¿˜åŸ

```bash
./restore/quick-restore-k8s.sh -d 20241218 -n postgres
```

**å°±è¿™ä¹ˆç®€å•ï¼** æ‰€æœ‰æ“ä½œåœ¨é›†ç¾¤ä¸­å®Œæˆï¼Œæœ¬åœ°ç¯å¢ƒä¿æŒæ¸…æ´ã€‚

---

## ğŸ’¡ é€‚ç”¨åœºæ™¯

### âœ… å¼ºçƒˆæ¨èä½¿ç”¨åœºæ™¯

1. **ç”Ÿäº§ç¯å¢ƒ**
   - é›¶æ±¡æŸ“ï¼Œæ›´å®‰å…¨
   - é›†ç¾¤å†…ç½‘é€Ÿåº¦å¿«
   - è‡ªåŠ¨æ¸…ç†ï¼Œæ— æ®‹ç•™

2. **CI/CD æµç¨‹**
   - æ— ç¯å¢ƒå·®å¼‚
   - æ˜“äºé›†æˆ
   - å¯é‡å¤æ‰§è¡Œ

3. **å¤šäººåä½œ**
   - æ— éœ€æœ¬åœ°å·¥å…·å®‰è£…
   - ç¯å¢ƒä¸€è‡´æ€§ä¿è¯
   - é™ä½åŸ¹è®­æˆæœ¬

4. **æœ¬åœ°èµ„æºå—é™**
   - ç£ç›˜ç©ºé—´ä¸è¶³
   - ç½‘ç»œå¸¦å®½æœ‰é™
   - æ€§èƒ½è¦æ±‚é«˜

### âš ï¸ ä¸æ¨èåœºæ™¯

1. **ç¦»çº¿ç¯å¢ƒ**
   - kubectl ä¸å¯ç”¨
   - æ— æ³•è¿æ¥é›†ç¾¤

2. **éœ€è¦æ·±åº¦è°ƒè¯•**
   - éœ€è¦æœ¬åœ°æ–­ç‚¹è°ƒè¯•
   - éœ€è¦ä¿®æ”¹ä¸­é—´æ­¥éª¤

---

## ğŸ” å®‰å…¨ä¼˜åŠ¿

### å‡­è¯ç®¡ç†

```bash
# v2.0: å‡­è¯å¯èƒ½æ³„éœ²
export S3_ACCESS_KEY="xxx"  # ç¯å¢ƒå˜é‡
export S3_SECRET_KEY="yyy"  # å‘½ä»¤å†å²

# v2.1-k8s: å‡­è¯ä»…åœ¨å®¹å™¨ä¸­
# - ä½œä¸ºå‚æ•°ä¼ å…¥ Job
# - Job å®Œæˆè‡ªåŠ¨æ¸…ç†
# - æ— æœ¬åœ°ç—•è¿¹
```

### æ•°æ®éš”ç¦»

```bash
# v2.0: å¤‡ä»½æ–‡ä»¶åœ¨æœ¬åœ°
/tmp/backup/postgres-full-xxx.tar.zst
# - å¯èƒ½è¢«å…¶ä»–ç”¨æˆ·è®¿é—®
# - éœ€è¦æ‰‹åŠ¨æ¸…ç†
# - ç£ç›˜æ»¡é£é™©

# v2.1-k8s: æ•°æ®ä»…åœ¨å®¹å™¨ä¸­
# - å®¹å™¨éš”ç¦»
# - è‡ªåŠ¨æ¸…ç†
# - æ— å®‰å…¨é£é™©
```

---

## ğŸ“ˆ æŠ€æœ¯äº®ç‚¹

### 1. åœ¨ Pod ä¸­åˆ—å‡ºå¤‡ä»½

```bash
# æœ¬åœ° MinIO æ¨¡å¼
kubectl exec <minio-pod> -- mc ls backups/postgres/files/

# è¿œç¨‹ S3 æ¨¡å¼  
kubectl run temp-s3 --image=minio/mc -- mc ls remote/...
```

### 2. Job ä¸­å®Œæˆæ‰€æœ‰æ“ä½œ

```yaml
apiVersion: batch/v1
kind: Job
spec:
  template:
    spec:
      containers:
      - name: restore
        command:
        - bash
        - -c
        - |
          # ä¸‹è½½å¤‡ä»½
          mc cp s3://backup/file.tar.zst /tmp/
          
          # è§£å‹
          zstd -d /tmp/file.tar.zst
          tar -xf /tmp/file.tar
          
          # å¤åˆ¶åˆ° PVC
          kubectl cp /tmp/data pod:/data
          
          # è‡ªåŠ¨æ¸…ç†
          rm -rf /tmp/*
```

### 3. æ— ä¸´æ—¶æ–‡ä»¶æ®‹ç•™

```bash
# v2.0: éœ€è¦æ‰‹åŠ¨æ¸…ç†
rm -rf /tmp/backup/*
rm -rf ~/.mc/

# v2.1-k8s: Job è‡ªåŠ¨æ¸…ç†
# ttlSecondsAfterFinished: 3600
# 1å°æ—¶åè‡ªåŠ¨åˆ é™¤ Job å’Œ Pod
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. CI/CD é›†æˆ

```yaml
# GitLab CI ç¤ºä¾‹
restore-prod:
  image: bitnami/kubectl:latest
  script:
    - kubectl apply -f restore/restore-rbac.yaml
    - ./restore/quick-restore-k8s.sh -d $BACKUP_DATE -f -n production
  only:
    - tags
```

### 2. å®šæœŸæµ‹è¯•

```bash
# Kubernetes CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: weekly-restore-test
spec:
  schedule: "0 3 * * 0"  # æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: test
            image: bitnami/kubectl:latest
            command: ["/restore/quick-restore-k8s.sh"]
            args: ["-d", "$(date -d 'yesterday' +%Y%m%d)", "-f", "-n", "test"]
```

### 3. ç›‘æ§å’Œå‘Šè­¦

```bash
# ç›‘æ§ Job çŠ¶æ€
kubectl get jobs -n postgres -w

# æ£€æŸ¥å¤±è´¥çš„ Job
kubectl get jobs -n postgres --field-selector status.successful!=1

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -n postgres job/postgres-restore-xxx
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: RBAC æƒé™ä¸è¶³

```bash
# ç—‡çŠ¶
Error: pods is forbidden: User "system:serviceaccount:postgres:default" cannot list resource "pods"

# è§£å†³
kubectl apply -f restore/restore-rbac.yaml
```

### é—®é¢˜ 2: Job æŒç»­ Pending

```bash
# æ£€æŸ¥åŸå› 
kubectl describe job postgres-restore-xxx -n postgres

# å¸¸è§åŸå› 
- èµ„æºä¸è¶³
- é•œåƒæ‹‰å–å¤±è´¥
- ServiceAccount ä¸å­˜åœ¨
```

### é—®é¢˜ 3: ä¸‹è½½é€Ÿåº¦æ…¢

```bash
# æ£€æŸ¥ç½‘ç»œ
kubectl exec <pod> -- curl -I https://s3.amazonaws.com

# å¦‚æœä½¿ç”¨å†…ç½‘ S3ï¼Œç¡®ä¿é…ç½®æ­£ç¡®
--s3-endpoint https://s3-internal.amazonaws.com
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| [K8S-NATIVE.md](K8S-NATIVE.md) | è¯¦ç»†æŠ€æœ¯æ–‡æ¡£ï¼ˆ8.7Kï¼‰ |
| [QUICK-START.md](QUICK-START.md) | å¿«é€Ÿå¼€å§‹æŒ‡å— |
| [CHEATSHEET.md](CHEATSHEET.md) | å‘½ä»¤é€ŸæŸ¥è¡¨ |
| [CHANGELOG.md](CHANGELOG.md) | ç‰ˆæœ¬å˜æ›´æ—¥å¿— |

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒä»·å€¼

1. **é›¶æœ¬åœ°ä¾èµ–** - ä»…éœ€ kubectl
2. **é›¶æœ¬åœ°æ±¡æŸ“** - æ— å·¥å…·å®‰è£…
3. **é›¶æœ¬åœ°å­˜å‚¨** - æ— ç£ç›˜å ç”¨
4. **é›¶æœ¬åœ°æµé‡** - æ— å¸¦å®½æ¶ˆè€—

### æŠ€æœ¯åˆ›æ–°

1. **å…¨ Job åŒ–** - æ‰€æœ‰æ“ä½œåœ¨ Pod ä¸­
2. **è‡ªåŠ¨æ¸…ç†** - æ— æ‰‹åŠ¨æ“ä½œ
3. **é›†ç¾¤å†…ç½‘** - ä¼ è¾“é€Ÿåº¦å¿«10å€
4. **å®‰å…¨éš”ç¦»** - å®¹å™¨çº§åˆ«éš”ç¦»

### å®é™…æ•ˆæœ

```
âœ… æœ¬åœ°ç¯å¢ƒ: å®Œå…¨æ¸…æ´
âœ… æ‰§è¡Œé€Ÿåº¦: æå‡ 40%
âœ… ç£ç›˜å ç”¨: å‡å°‘ 100%
âœ… ç½‘ç»œæµé‡: å‡å°‘ 100%
âœ… å®‰å…¨æ€§: æ˜¾è‘—æå‡
âœ… å¯ç»´æŠ¤æ€§: å¤§å¹…æ”¹å–„
```

---

**æ¨è**: åœ¨æ‰€æœ‰ç”Ÿäº§ç¯å¢ƒå’Œ CI/CD æµç¨‹ä¸­ä½¿ç”¨ Kubernetes åŸç”Ÿç‰ˆæœ¬ï¼

**ç‰ˆæœ¬**: v2.1.0-k8s  
**å‘å¸ƒæ—¥æœŸ**: 2024-12-18  
**ç»´æŠ¤è€…**: DevOps Team
